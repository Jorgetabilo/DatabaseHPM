<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Base de Datos Neuroquirúrgica HPM (Sheets)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@600;700&family=Lato:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Lato', sans-serif;
            background-color: #111827;
            color: #e5e7eb;
            overflow: hidden;
        }
        .font-title {
            font-family: 'Cormorant Garamond', serif;
        }
        .hpm-gradient {
            background: linear-gradient(to right, #60a5fa, #3b82f6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .form-input, .form-select {
            background-color: #1f2937;
            border: 1px solid #4b5563;
            color: #e5e7eb;
            border-radius: 0.5rem;
        }
        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px #1e40af;
        }
        .btn-primary {
            background-color: #3b82f6;
            color: #ffffff;
            font-weight: 600;
            border-radius: 0.5rem;
            transition: background-color 0.3s;
        }
        .btn-primary:hover { background-color: #2563eb; }
        .btn-primary:disabled { background-color: #2563eb; opacity: 0.5; cursor: not-allowed; }
        .btn-secondary {
            background-color: #4b5563;
            color: #ffffff;
            font-weight: 600;
            border-radius: 0.5rem;
            transition: background-color 0.3s;
        }
        .btn-secondary:hover { background-color: #6b7280; }
        .btn-ai {
            background-color: transparent;
            color: #60a5fa;
            border: 1px solid #60a5fa;
            padding: 2px 6px;
            font-size: 0.75rem;
            border-radius: 0.5rem;
            transition: all 0.2s;
        }
        .btn-ai:hover { background-color: #60a5fa; color: #111827; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .glass-effect {
            background: rgba(31, 41, 55, 0.6);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        #splash-screen {
            position: fixed;
            inset: 0;
            background-color: #111827;
            z-index: 100;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.8s ease-out;
            opacity: 1;
        }
        #splash-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }
        .app-container {
            transition: opacity 0.5s ease-in 0.5s;
            opacity: 0;
        }
        .app-container.visible {
            opacity: 1;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .splash-logo { animation: fadeIn 0.8s ease-out; }
        .splash-title { animation: fadeIn 1s ease-out; }
        .splash-credits { animation: fadeIn 1.4s ease-out; }
        .splash-button { animation: fadeIn 1.8s ease-out; }
    </style>
</head>
<body>

    <div id="splash-screen">
        <div class="text-center p-4">
            <svg class="splash-logo mx-auto h-24 w-24 text-white mb-6" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M12 2V22" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M2 12H22" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M18 12C18 15.3137 15.3137 18 12 18C8.68629 18 6 15.3137 6 12C6 8.68629 8.68629 6 12 6C15.3137 6 18 8.68629 18 12Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M12 18V22" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M12 2V6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <h1 class="splash-title text-4xl md:text-6xl font-bold text-white tracking-tight font-title">Base de Datos Neuroquirúrgica <span class="hpm-gradient">HPM</span></h1>
            <p class="splash-credits text-md text-gray-400 mt-12 font-title">Desarrollada y creada por Dr. Jorge Tabilo</p>
            <button id="enter-app-btn" class="splash-button mt-8 btn-primary py-3 px-8 text-lg">Entrar</button>
        </div>
    </div>

    <div id="app-container" class="max-w-5xl mx-auto">
        <header class="text-center mb-8">
             <div class="flex items-center justify-center gap-4">
                <svg class="h-14 w-14 text-white" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 2V22" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M2 12H22" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M18 12C18 15.3137 15.3137 18 12 18C8.68629 18 6 15.3137 6 12C6 8.68629 8.68629 6 12 6C15.3137 6 18 8.68629 18 12Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 18V22" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 2V6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
                <h1 class="text-4xl md:text-5xl font-bold text-white tracking-tight font-title">Base de Datos Neuroquirúrgica <span class="hpm-gradient">HPM</span></h1>
            </div>
            <div class="mt-4">
                <a href="https://docs.google.com/spreadsheets/d/109ZE0aXq_tIteMiehespk7HOrDPLB_OSpTgxIe5jciI/edit?usp=sharing" target="_blank" class="btn-secondary py-2 px-4 text-sm inline-flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M10 9H8"/><path d="M16 13H8"/><path d="M16 17H8"/></svg>
                    Abrir Google Sheet
                </a>
            </div>
        </header>

        <main>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="glass-effect p-6 rounded-2xl">
                    <h2 class="text-2xl font-semibold mb-4 text-white font-title">1. Cargar Protocolo</h2>
                    <div class="bg-gray-700/50 border-2 border-dashed border-gray-500 rounded-xl p-6 text-center">
                        <img id="image-preview" src="" class="hidden max-h-80 mx-auto rounded-lg mb-4" alt="Vista previa del protocolo">
                        <div id="upload-placeholder">
                            <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true"><path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                            <p class="mt-2 text-gray-400">Sube una foto o arrástrala aquí</p>
                        </div>
                        <input type="file" id="image-upload" class="hidden" accept="image/*">
                        <button id="upload-button" class="mt-4 btn-secondary py-2 px-4">Seleccionar Archivo</button>
                    </div>
                    <button id="process-button" class="mt-6 w-full btn-primary py-3 text-lg flex items-center justify-center gap-2" disabled>
                        <span id="process-button-text">✨ Extraer Datos con IA</span>
                        <div id="loader" class="hidden loader w-6 h-6 border-2"></div>
                    </button>
                </div>

                <div class="glass-effect p-6 rounded-2xl">
                    <h2 class="text-2xl font-semibold mb-4 text-white font-title">2. Verificar y Enviar</h2>
                     <div id="form-container" class="space-y-4">
                        <input type="text" id="nombre" placeholder="Nombre del Paciente" class="w-full p-3 form-input">
                        <input type="text" id="rut" placeholder="RUT del Paciente" class="w-full p-3 form-input">
                        <input type="text" id="cirujanos" placeholder="Cirujanos (separados por coma)" class="w-full p-3 form-input">
                        <input type="text" id="ayudante" placeholder="Ayudante" class="w-full p-3 form-input">
                        <input type="text" id="tiempos" placeholder="Tiempos Quirúrgicos" class="w-full p-3 form-input">
                        <input type="text" id="codigos" placeholder="Códigos (separados por coma)" class="w-full p-3 form-input">
                        
                        <div class="flex justify-between items-center">
                            <label for="tecnica" class="text-gray-300">Técnica Quirúrgica</label>
                            <button id="generate-technique-btn" class="btn-ai">Generar ✨</button>
                        </div>
                        <textarea id="tecnica" placeholder="Especifique la técnica, o use el botón 'Generar ✨'." class="w-full p-3 form-input h-28"></textarea>
                        
                        <select id="surgery-select" class="w-full p-3 form-select">
                            <option value="">Opcional: Añadir técnica predefinida</option>
                            <option value="Craneotomía, fenestración lámina">Craneotomía, fenestración lámina</option>
                            <option value="Aneurisma ACA">Aneurisma ACA</option>
                            <option value="Aneurisma Múltiple">Aneurisma Múltiple</option>
                        </select>
                        
                        <button id="save-button" class="w-full btn-primary py-3 text-lg !mt-6">Enviar a Google Sheets</button>
                    </div>
                </div>
            </div>
        </main>
        
        <div id="notification-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4"><div class="bg-gray-800 rounded-lg p-6 shadow-xl text-left max-w-md w-full"><p id="notification-message" class="text-lg whitespace-pre-wrap"></p><button id="notification-close" class="mt-4 w-full btn-primary py-2 px-6">OK</button></div></div>
        <div id="keywords-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4"><div class="bg-gray-800 rounded-lg p-6 shadow-xl text-left max-w-md w-full"><h3 class="text-xl font-semibold mb-4 font-title">Generar Técnica Quirúrgica</h3><p class="text-gray-400 mb-4">Introduce palabras clave para que la IA genere la descripción.</p><input type="text" id="keywords-input" class="w-full p-3 form-input" placeholder="Ej: craneotomía pterional, clipaje de aneurisma..."><div class="mt-6 flex justify-end space-x-4"><button id="keywords-cancel" class="btn-secondary py-2 px-6">Cancelar</button><button id="keywords-generate" class="btn-primary py-2 px-6">Generar</button></div></div></div>
    </div>

    <script type="module">
        let base64ImageData = null;

        const splashScreen = document.getElementById('splash-screen');
        const appContainer = document.getElementById('app-container');
        const enterAppBtn = document.getElementById('enter-app-btn');
        const uploadButton = document.getElementById('upload-button');
        const imageUpload = document.getElementById('image-upload');
        const imagePreview = document.getElementById('image-preview');
        const uploadPlaceholder = document.getElementById('upload-placeholder');
        const processButton = document.getElementById('process-button');
        const loader = document.getElementById('loader');
        const processButtonText = document.getElementById('process-button-text');
        const saveButton = document.getElementById('save-button');
        const generateTechniqueBtn = document.getElementById('generate-technique-btn');
        const surgerySelect = document.getElementById('surgery-select');

        const form = {
            nombre: document.getElementById('nombre'),
            rut: document.getElementById('rut'),
            cirujanos: document.getElementById('cirujanos'),
            ayudante: document.getElementById('ayudante'),
            tiempos: document.getElementById('tiempos'),
            codigos: document.getElementById('codigos'),
            tecnica: document.getElementById('tecnica')
        };
        
        const notificationModal = document.getElementById('notification-modal');
        const notificationMessage = document.getElementById('notification-message');
        const notificationClose = document.getElementById('notification-close');
        const keywordsModal = document.getElementById('keywords-modal');
        const keywordsInput = document.getElementById('keywords-input');
        const keywordsCancel = document.getElementById('keywords-cancel');
        const keywordsGenerate = document.getElementById('keywords-generate');

        document.addEventListener('DOMContentLoaded', () => {
            setupEventListeners();
        });

        function setupEventListeners() {
            enterAppBtn.addEventListener('click', () => {
                splashScreen.classList.add('hidden');
                document.body.style.overflow = 'auto';
                appContainer.classList.add('visible');
            });
            uploadButton.addEventListener('click', () => imageUpload.click());
            imageUpload.addEventListener('change', handleImageUpload);
            processButton.addEventListener('click', handleProcessImage);
            saveButton.addEventListener('click', handleSaveData);
            generateTechniqueBtn.addEventListener('click', () => keywordsModal.classList.remove('hidden'));
            notificationClose.addEventListener('click', () => notificationModal.classList.add('hidden'));
            keywordsCancel.addEventListener('click', () => keywordsModal.classList.add('hidden'));
            keywordsGenerate.addEventListener('click', handleGenerateTechnique);
            surgerySelect.addEventListener('change', handleSelectSurgery);
        }

        async function callGeminiAPI(prompt, imageData = null) {
            const apiKey = "AIzaSyA0kt2tCTGWsmek2a7HqAdiIygc1mxfXww";

            if (!apiKey) {
                throw new Error("API Key de Gemini no encontrada.");
            }

            const model = 'gemini-2.5-flash-preview-05-20';
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
            
            let parts = [{ text: prompt }];
            if (imageData) {
                parts.push({ inlineData: { mimeType: "image/jpeg", data: imageData } });
            }

            const payload = {
                contents: [{ parts: parts }],
                generationConfig: { responseMimeType: "application/json" }
            };

            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) {
                const errorBody = await response.text();
                console.error("Error response from Gemini API:", errorBody);
                throw new Error(`Error en la API de Gemini: ${response.status}.`);
            }
            const result = await response.json();
            if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts[0]) {
                const responseText = result.candidates[0].content.parts[0].text;
                return JSON.parse(responseText);
            } else {
                throw new Error("Respuesta inesperada de la API de Gemini.");
            }
        }
        
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                imagePreview.src = e.target.result;
                imagePreview.classList.remove('hidden');
                uploadPlaceholder.classList.add('hidden');
                base64ImageData = e.target.result.split(',')[1];
                processButton.disabled = false;
            };
            reader.readAsDataURL(file);
        }

        async function handleProcessImage() {
            if (!base64ImageData) {
                showNotification("Por favor, sube una imagen primero.");
                return;
            }
            setLoading(true, processButton, processButtonText, 'Procesando...');
            const prompt = `Analiza la imagen de este protocolo neuroquirúrgico y extrae la siguiente información en formato JSON. Si un campo no se encuentra, déjalo como un string vacío o un array vacío. La estructura debe ser: {"patientName": "","patientRUT": "","surgeons": [],"assistant": "","surgicalTimes": "","surgicalCodes": []}`;
            try {
                const result = await callGeminiAPI(prompt, base64ImageData);
                populateForm(result);
                showNotification("Datos extraídos con éxito. Por favor, verifica la información.");
            } catch (error) {
                showNotification(error.message);
            } finally {
                setLoading(false, processButton, processButtonText, '✨ Extraer Datos con IA');
            }
        }
        
        function populateForm(data) {
            form.nombre.value = data.patientName || '';
            form.rut.value = data.patientRUT || '';
            form.cirujanos.value = (data.surgeons || []).join(', ');
            form.ayudante.value = data.assistant || '';
            form.tiempos.value = data.surgicalTimes || '';
            form.codigos.value = (data.surgicalCodes || []).join(', ');
            form.tecnica.value = '';
        }
        
        async function handleGenerateTechnique() {
            const keywords = keywordsInput.value.trim();
            if (!keywords) {
                showNotification("Por favor, introduce algunas palabras clave.");
                return;
            }
            keywordsModal.classList.add('hidden');
            form.tecnica.value = "Generando descripción con IA...";
            const promptText = `Eres un neurocirujano experto redactando protocolos. Basado en las siguientes palabras clave, redacta una descripción de técnica quirúrgica detallada, profesional y bien estructurada. Usa un lenguaje técnico preciso.\n\nPalabras clave: "${keywords}"`;
            try {
                const responseJson = await callGeminiAPI(promptText);
                const generatedText = responseJson.text || JSON.stringify(responseJson);
                form.tecnica.value = generatedText;
            } catch (error) {
                 form.tecnica.value = `Error al generar: ${error.message}`;
            }
        }

        async function handleSaveData() {
            const protocolData = {
                patientName: form.nombre.value.trim(),
                patientRUT: form.rut.value.trim(),
                surgeons: form.cirujanos.value.split(',').map(s => s.trim()).filter(Boolean),
                assistant: form.ayudante.value.trim(),
                surgicalTimes: form.tiempos.value.trim(),
                surgicalCodes: form.codigos.value.split(',').map(c => c.trim()).filter(Boolean),
                technique: form.tecnica.value.trim()
            };

            if (!protocolData.patientName || !protocolData.patientRUT) {
                showNotification("El nombre y el RUT del paciente son obligatorios.");
                return;
            }
            
            setLoading(true, saveButton, null, 'Enviando...');
            const googleScriptURL = 'https://script.google.com/macros/s/AKfycbw06xYE5XyaMeSWTDdM0XUfc5D41BuYg-w8Hds5ScZ49jJ6tc2L8uEtu_WJoTCPT4xP8Q/exec';
            
            try {
                await fetch(googleScriptURL, {
                    method: 'POST',
                    mode: 'no-cors',
                    redirect: 'follow',
                    body: JSON.stringify(protocolData)
                });
                
                showNotification("¡Éxito! Los datos del protocolo han sido enviados a Google Sheets.");
                resetForm();
            } catch (error) {
                console.error("Error en la solicitud a Google Sheets:", error);
                showNotification("Error al enviar los datos. Por favor, revisa la consola para más detalles.");
            } finally {
                setLoading(false, saveButton, null, 'Enviar a Google Sheets');
            }
        }
        
        function handleSelectSurgery() {
            const selectedSurgery = surgerySelect.value;
            if (selectedSurgery) {
                const currentTechnique = form.tecnica.value;
                form.tecnica.value = currentTechnique ? `${currentTechnique}\n- ${selectedSurgery}` : `- ${selectedSurgery}`;
                surgerySelect.value = "";
            }
        }

        function setLoading(isLoading, button, textElement, text) {
            button.disabled = isLoading;
            const target = textElement || button;
            target.textContent = text;
            if (button.id === 'process-button') {
                isLoading ? loader.classList.remove('hidden') : loader.classList.add('hidden');
            }
        }

        function resetForm() {
            Object.values(form).forEach(input => input.value = '');
            imagePreview.src = '';
            imagePreview.classList.add('hidden');
            uploadPlaceholder.classList.remove('hidden');
            base64ImageData = null;
            processButton.disabled = true;
        }
        
        function showNotification(message) {
            notificationMessage.innerHTML = message.replace(/\n/g, '<br>');
            notificationModal.classList.remove('hidden');
        }

    </script>
</body>
</html>
